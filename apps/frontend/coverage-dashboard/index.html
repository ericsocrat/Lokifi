<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lokifi Coverage Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .gauge-container {
        position: relative;
        width: 150px;
        height: 150px;
        margin: 0 auto;
      }
      .gauge-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
        font-weight: bold;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-white min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-900 to-purple-900 p-6 shadow-lg">
      <div class="container mx-auto">
        <h1 class="text-4xl font-bold mb-2">üìä Lokifi Test Coverage Dashboard</h1>
        <p class="text-gray-300">Real-time test coverage analytics and trends</p>
        <p class="text-sm text-gray-400 mt-2">
          Last updated: <span id="lastUpdate" class="text-blue-400">Loading...</span>
        </p>
        <div
          id="viewHint"
          class="text-xs text-yellow-400 mt-2 bg-yellow-900/20 px-3 py-2 rounded border border-yellow-700"
          style="display: none"
        >
          üí° <strong>Tip:</strong> For best results, serve this dashboard with:
          <code class="bg-gray-800 px-2 py-1 rounded ml-1">npx serve coverage-dashboard</code>
        </div>
      </div>
    </header>

    <!-- Quick Stats Bar -->
    <section class="bg-gray-800 border-b border-gray-700 py-4">
      <div class="container mx-auto px-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
          <div>
            <div class="text-2xl font-bold text-blue-400" id="totalTests">-</div>
            <div class="text-sm text-gray-400">Total Tests</div>
          </div>
          <div>
            <div class="text-2xl font-bold text-green-400" id="passingTests">-</div>
            <div class="text-sm text-gray-400">Passing</div>
          </div>
          <div>
            <div class="text-2xl font-bold text-yellow-400" id="testFiles">-</div>
            <div class="text-sm text-gray-400">Test Files</div>
          </div>
          <div>
            <div class="text-2xl font-bold text-purple-400" id="testDuration">-</div>
            <div class="text-sm text-gray-400">Duration</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Coverage Overview Gauges -->
    <section class="container mx-auto px-6 py-8">
      <h2 class="text-3xl font-bold mb-6">Coverage Overview</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Statements -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
          <h3 class="text-xl font-semibold mb-4 text-center text-blue-400">Statements</h3>
          <div class="gauge-container">
            <canvas id="statementsGauge"></canvas>
            <div class="gauge-text" id="statementsText">-</div>
          </div>
          <div class="text-center mt-4">
            <span class="text-sm text-gray-400" id="statementsDelta">-</span>
          </div>
        </div>

        <!-- Branches -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
          <h3 class="text-xl font-semibold mb-4 text-center text-green-400">Branches</h3>
          <div class="gauge-container">
            <canvas id="branchesGauge"></canvas>
            <div class="gauge-text" id="branchesText">-</div>
          </div>
          <div class="text-center mt-4">
            <span class="text-sm text-gray-400" id="branchesDelta">-</span>
          </div>
        </div>

        <!-- Functions -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
          <h3 class="text-xl font-semibold mb-4 text-center text-yellow-400">Functions</h3>
          <div class="gauge-container">
            <canvas id="functionsGauge"></canvas>
            <div class="gauge-text" id="functionsText">-</div>
          </div>
          <div class="text-center mt-4">
            <span class="text-sm text-gray-400" id="functionsDelta">-</span>
          </div>
        </div>

        <!-- Lines -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
          <h3 class="text-xl font-semibold mb-4 text-center text-purple-400">Lines</h3>
          <div class="gauge-container">
            <canvas id="linesGauge"></canvas>
            <div class="gauge-text" id="linesText">-</div>
          </div>
          <div class="text-center mt-4">
            <span class="text-sm text-gray-400" id="linesDelta">-</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Trend Charts -->
    <section class="container mx-auto px-6 py-8">
      <h2 class="text-3xl font-bold mb-6">Coverage Trends</h2>
      <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
        <div class="mb-4">
          <h3 class="text-xl font-semibold">Historical Coverage (Last 30 Days)</h3>
          <p class="text-sm text-gray-400">Track how your test coverage has evolved over time</p>
        </div>
        <canvas id="trendChart" class="w-full" style="max-height: 400px"></canvas>
      </div>
    </section>

    <!-- Module Breakdown -->
    <section class="container mx-auto px-6 py-8">
      <h2 class="text-3xl font-bold mb-6">Module Coverage</h2>
      <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
        <div class="mb-4">
          <h3 class="text-xl font-semibold">Coverage by Module</h3>
          <p class="text-sm text-gray-400">Identify which modules need more test coverage</p>
        </div>
        <canvas id="moduleChart" class="w-full" style="max-height: 400px"></canvas>
      </div>
    </section>

    <!-- Key Insights Section (NEW) -->
    <section class="container mx-auto px-6 py-8" id="insightsSection" style="display: none">
      <h2 class="text-3xl font-bold mb-6">üí° Key Insights</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="insightsContainer">
        <!-- Insights will be dynamically populated -->
      </div>
    </section>

    <!-- Summary Statistics (NEW) -->
    <section class="container mx-auto px-6 py-8" id="summarySection" style="display: none">
      <h2 class="text-3xl font-bold mb-6">üìä Summary Statistics</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <div class="bg-gray-800 p-6 rounded-lg">
          <div class="text-3xl font-bold text-blue-400" id="totalFilesCount">-</div>
          <div class="text-sm text-gray-400 mt-2">Total Files</div>
        </div>
        <div class="bg-gray-800 p-6 rounded-lg">
          <div class="text-3xl font-bold text-green-400" id="healthyFilesCount">-</div>
          <div class="text-sm text-gray-400 mt-2">Healthy Files (>80%)</div>
        </div>
        <div class="bg-gray-800 p-6 rounded-lg">
          <div class="text-3xl font-bold text-red-400" id="criticalFilesCount">-</div>
          <div class="text-sm text-gray-400 mt-2">Critical Files (<40%)</div>
        </div>
        <div class="bg-gray-800 p-6 rounded-lg">
          <div class="text-3xl font-bold text-purple-400" id="avgComplexity">-</div>
          <div class="text-sm text-gray-400 mt-2">Avg Complexity</div>
        </div>
      </div>

      <!-- Velocity Metrics -->
      <div
        class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-6"
        id="velocitySection"
        style="display: none"
      >
        <div class="bg-gray-800 p-6 rounded-lg border-l-4 border-blue-500">
          <div class="text-2xl font-bold text-blue-400" id="testsPerDay">-</div>
          <div class="text-sm text-gray-400 mt-2">Tests Added/Day</div>
        </div>
        <div class="bg-gray-800 p-6 rounded-lg border-l-4 border-green-500">
          <div class="text-2xl font-bold text-green-400" id="coverageGain">-</div>
          <div class="text-sm text-gray-400 mt-2">Coverage Gain/Run</div>
        </div>
        <div class="bg-gray-800 p-6 rounded-lg border-l-4 border-purple-500">
          <div class="text-2xl font-bold text-purple-400" id="totalRuns">-</div>
          <div class="text-sm text-gray-400 mt-2">Total Coverage Runs</div>
        </div>
      </div>
    </section>

    <!-- Recommendations (NEW) -->
    <section class="container mx-auto px-6 py-8" id="recommendationsSection" style="display: none">
      <h2 class="text-3xl font-bold mb-6">üéØ Recommended Actions</h2>
      <div class="space-y-4" id="recommendationsContainer">
        <!-- Recommendations will be dynamically populated -->
      </div>
    </section>

    <!-- Top Files (NEW) -->
    <section class="container mx-auto px-6 py-8" id="topFilesSection" style="display: none">
      <h2 class="text-3xl font-bold mb-6">üìà Notable Files</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Best Coverage -->
        <div class="bg-gray-800 p-6 rounded-lg">
          <h3 class="text-xl font-semibold mb-4 text-green-400">üèÜ Best Coverage</h3>
          <div class="space-y-2" id="bestCoverageList">
            <div class="text-gray-400 text-sm">Loading...</div>
          </div>
        </div>

        <!-- Most Complex -->
        <div class="bg-gray-800 p-6 rounded-lg">
          <h3 class="text-xl font-semibold mb-4 text-yellow-400">üîß Most Complex</h3>
          <div class="space-y-2" id="mostComplexList">
            <div class="text-gray-400 text-sm">Loading...</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Coverage Gaps -->
    <section class="container mx-auto px-6 py-8">
      <h2 class="text-3xl font-bold mb-6">Coverage Gaps</h2>
      <div class="bg-gray-800 p-6 rounded-lg shadow-lg overflow-x-auto">
        <div class="mb-4">
          <h3 class="text-xl font-semibold">Files Needing Tests</h3>
          <p class="text-sm text-gray-400">High-priority files with low or missing test coverage</p>
        </div>

        <!-- Search & Filter Controls -->
        <div class="mb-6 p-4 bg-gray-700/50 rounded-lg border border-gray-600">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <!-- Search Box -->
            <div>
              <label class="block text-xs text-gray-400 mb-1">üîç Search Files</label>
              <input
                type="text"
                id="searchBox"
                placeholder="Type filename..."
                class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded text-sm focus:outline-none focus:border-blue-500 text-white"
                oninput="applyFilters()"
              />
            </div>

            <!-- Priority Filter -->
            <div>
              <label class="block text-xs text-gray-400 mb-1">üéØ Priority</label>
              <select
                id="priorityFilter"
                class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded text-sm focus:outline-none focus:border-blue-500 text-white"
                onchange="applyFilters()"
              >
                <option value="ALL">All Priorities</option>
                <option value="HIGH">üî¥ HIGH only</option>
                <option value="MEDIUM">üü° MEDIUM only</option>
                <option value="LOW">üü¢ LOW only</option>
              </select>
            </div>

            <!-- Module Filter -->
            <div>
              <label class="block text-xs text-gray-400 mb-1">üìÅ Module</label>
              <select
                id="moduleFilter"
                class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded text-sm focus:outline-none focus:border-blue-500 text-white"
                onchange="applyFilters()"
              >
                <option value="ALL">All Modules</option>
                <!-- Populated dynamically -->
              </select>
            </div>

            <!-- Sort Control -->
            <div>
              <label class="block text-xs text-gray-400 mb-1">üìä Sort By</label>
              <select
                id="sortControl"
                class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded text-sm focus:outline-none focus:border-blue-500 text-white"
                onchange="applyFilters()"
              >
                <option value="priority">Priority (default)</option>
                <option value="impact-desc">Impact (high to low)</option>
                <option value="impact-asc">Impact (low to high)</option>
                <option value="complexity-desc">Complexity (high to low)</option>
                <option value="complexity-asc">Complexity (low to high)</option>
                <option value="coverage-asc">Coverage (low to high)</option>
                <option value="coverage-desc">Coverage (high to low)</option>
                <option value="filename">Filename (A-Z)</option>
              </select>
            </div>
          </div>

          <!-- Results Counter & Clear Button -->
          <div class="flex justify-between items-center">
            <div class="text-sm text-gray-400">
              Showing <span id="filteredCount" class="text-blue-400 font-semibold">0</span> of
              <span id="totalCount" class="text-gray-300 font-semibold">0</span> gaps
              <span id="filterStatus" class="text-yellow-400 ml-2"></span>
            </div>
            <button
              id="clearFiltersBtn"
              onclick="clearAllFilters()"
              class="px-4 py-1 bg-red-600/20 hover:bg-red-600/40 text-red-400 rounded text-sm border border-red-600/50 transition-colors"
              style="display: none"
            >
              ‚úï Clear Filters
            </button>
          </div>
        </div>

        <table class="w-full text-sm" id="gapsTable">
          <thead>
            <tr class="border-b border-gray-700">
              <th class="text-left py-3 px-4">Priority</th>
              <th class="text-left py-3 px-4">File</th>
              <th class="text-center py-3 px-4">Coverage</th>
              <th class="text-center py-3 px-4">Uncovered Lines</th>
              <th class="text-center py-3 px-4">Complexity</th>
              <th class="text-center py-3 px-4">Impact</th>
              <th class="text-center py-3 px-4">Actions</th>
            </tr>
          </thead>
          <tbody id="gapsTableBody">
            <tr>
              <td colspan="7" class="text-center py-8 text-gray-400">Loading coverage gaps...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Quick Actions -->
    <section class="container mx-auto px-6 py-8 mb-12">
      <h2 class="text-3xl font-bold mb-6">Quick Actions</h2>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
        <button
          onclick="refreshDashboard()"
          class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
        >
          üîÑ Refresh Data
        </button>
        <button
          onclick="runCoverage()"
          class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
        >
          üìä Run Coverage
        </button>
        <button
          onclick="runTests()"
          class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
        >
          üß™ Run Tests
        </button>
        <button
          onclick="getSuggestions()"
          class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
        >
          üéØ Test Suggestions
        </button>
        <button
          onclick="exportReport()"
          class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
        >
          üì• Export Report
        </button>
      </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-800 border-t border-gray-700 py-6 mt-12">
      <div class="container mx-auto px-6 text-center text-gray-400">
        <p>Generated by Lokifi Test Intelligence System</p>
        <p class="text-sm mt-2">Powered by Chart.js & Tailwind CSS</p>
      </div>
    </footer>

    <script>
      let dashboardData = null;
      let charts = {};

      // Utility: Get color based on coverage percentage
      function getCoverageColor(percentage) {
        if (percentage >= 80) return { bg: 'rgb(16, 185, 129)', text: 'text-green-400' };
        if (percentage >= 60) return { bg: 'rgb(251, 191, 36)', text: 'text-yellow-400' };
        if (percentage >= 40) return { bg: 'rgb(249, 115, 22)', text: 'text-orange-400' };
        return { bg: 'rgb(239, 68, 68)', text: 'text-red-400' };
      }

      // Create gauge chart
      function createGauge(canvasId, value, color) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, {
          type: 'doughnut',
          data: {
            datasets: [
              {
                data: [value, 100 - value],
                backgroundColor: [color, 'rgba(75, 85, 99, 0.3)'],
                borderWidth: 0,
              },
            ],
          },
          options: {
            circumference: 180,
            rotation: 270,
            cutout: '75%',
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false },
            },
            responsive: true,
            maintainAspectRatio: true,
          },
        });
      }

      // Create trend chart
      function createTrendChart(data) {
        const ctx = document.getElementById('trendChart').getContext('2d');

        if (charts.trend) {
          charts.trend.destroy();
        }

        charts.trend = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.trends.map((t) => new Date(t.timestamp).toLocaleDateString()),
            datasets: [
              {
                label: 'Statements %',
                data: data.trends.map((t) => t.coverage.statements),
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true,
              },
              {
                label: 'Branches %',
                data: data.trends.map((t) => t.coverage.branches),
                borderColor: 'rgb(16, 185, 129)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true,
              },
              {
                label: 'Functions %',
                data: data.trends.map((t) => t.coverage.functions),
                borderColor: 'rgb(251, 191, 36)',
                backgroundColor: 'rgba(251, 191, 36, 0.1)',
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top',
                labels: { color: 'rgb(209, 213, 219)' },
              },
              tooltip: {
                mode: 'index',
                intersect: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: { color: 'rgb(156, 163, 175)' },
                grid: { color: 'rgba(75, 85, 99, 0.3)' },
              },
              x: {
                ticks: { color: 'rgb(156, 163, 175)' },
                grid: { color: 'rgba(75, 85, 99, 0.3)' },
              },
            },
          },
        });
      }

      // Create module chart
      function createModuleChart(data) {
        const ctx = document.getElementById('moduleChart').getContext('2d');

        if (charts.module) {
          charts.module.destroy();
        }

        charts.module = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.modules.map((m) => m.name),
            datasets: [
              {
                label: 'Coverage %',
                data: data.modules.map((m) => m.coverage),
                backgroundColor: data.modules.map((m) => getCoverageColor(m.coverage).bg),
              },
            ],
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const module = data.modules[context.dataIndex];
                    return [
                      `Coverage: ${module.coverage}%`,
                      `Files: ${module.files}`,
                      `Tests: ${module.tests}`,
                    ];
                  },
                },
              },
            },
            scales: {
              x: {
                beginAtZero: true,
                max: 100,
                ticks: { color: 'rgb(156, 163, 175)' },
                grid: { color: 'rgba(75, 85, 99, 0.3)' },
              },
              y: {
                ticks: { color: 'rgb(209, 213, 219)' },
                grid: { display: false },
              },
            },
          },
        });
      }

      // Populate coverage gaps table
      function populateGapsTable(data) {
        const tbody = document.getElementById('gapsTableBody');

        if (!data.gaps || data.gaps.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center py-8 text-green-400">‚úÖ No significant coverage gaps found!</td></tr>';
          return;
        }

        tbody.innerHTML = data.gaps
          .map((gap) => {
            const priorityEmoji =
              gap.priority === 'HIGH' ? 'üî¥' : gap.priority === 'MEDIUM' ? 'üü°' : 'üü¢';
            const coverageColor = getCoverageColor(gap.coverage).text;

            // Get metrics with fallbacks for older data format
            const uncoveredLines =
              gap.metrics?.uncoveredLines ||
              (gap.lines ? gap.lines.total - gap.lines.covered : '-');
            const complexity = gap.metrics?.complexity || '-';
            const impact = gap.metrics?.impact || '-';

            return `
                    <tr class="border-b border-gray-700 hover:bg-gray-700 transition-colors">
                        <td class="py-3 px-4 text-center text-xl">${priorityEmoji}</td>
                        <td class="py-3 px-4 font-mono text-xs" title="${gap.fullPath || gap.file}">
                          <div class="max-w-xs truncate">${gap.file}</div>
                          ${gap.reason ? `<div class="text-gray-500 text-xs mt-1">${gap.reason}</div>` : ''}
                        </td>
                        <td class="py-3 px-4 text-center">
                          <div class="${coverageColor} font-bold">${gap.coverage}%</div>
                          ${gap.details ? `<div class="text-xs text-gray-500 mt-1">B: ${gap.details.branches}% F: ${gap.details.functions}%</div>` : ''}
                        </td>
                        <td class="py-3 px-4 text-center text-red-400 font-semibold">${uncoveredLines}</td>
                        <td class="py-3 px-4 text-center text-yellow-400">${complexity}</td>
                        <td class="py-3 px-4 text-center">
                          <span class="px-2 py-1 rounded text-xs ${
                            impact > 200
                              ? 'bg-red-600'
                              : impact > 100
                                ? 'bg-yellow-600'
                                : 'bg-blue-600'
                          }">${impact}</span>
                        </td>
                        <td class="py-3 px-4 text-center">
                            <button onclick="analyzeFile('${gap.fullPath || gap.file}')"
                              class="text-blue-400 hover:text-blue-300 text-xs px-2 py-1 rounded hover:bg-blue-900/30">
                                üéØ Analyze
                            </button>
                        </td>
                    </tr>
                `;
          })
          .join('');
      }

      // Global variable to store all gaps data for filtering
      let allGapsData = [];
      let currentDashboardData = null;

      // Extract unique modules from gaps data
      function getUniqueModules(gaps) {
        const modules = new Set();
        gaps.forEach((gap) => {
          const parts = gap.file.split('/');
          if (parts.length > 1) {
            modules.add(parts[0]); // First directory is the module
          }
        });
        return Array.from(modules).sort();
      }

      // Populate module filter dropdown
      function populateModuleFilter(gaps) {
        const moduleFilter = document.getElementById('moduleFilter');
        const modules = getUniqueModules(gaps);

        // Clear existing options except "All"
        moduleFilter.innerHTML = '<option value="ALL">All Modules</option>';

        // Add module options
        modules.forEach((module) => {
          const option = document.createElement('option');
          option.value = module;
          option.textContent = module;
          moduleFilter.appendChild(option);
        });
      }

      // Sort gaps based on selected criteria
      function sortGaps(gaps, sortBy) {
        const sorted = [...gaps];

        switch (sortBy) {
          case 'priority':
            // Default: HIGH > MEDIUM > LOW
            const priorityOrder = { HIGH: 0, MEDIUM: 1, LOW: 2 };
            sorted.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
            break;

          case 'impact-desc':
            sorted.sort(
              (a, b) => (b.metrics?.impact || 0) - (a.metrics?.impact || 0)
            );
            break;

          case 'impact-asc':
            sorted.sort(
              (a, b) => (a.metrics?.impact || 0) - (b.metrics?.impact || 0)
            );
            break;

          case 'complexity-desc':
            sorted.sort(
              (a, b) => (b.metrics?.complexity || 0) - (a.metrics?.complexity || 0)
            );
            break;

          case 'complexity-asc':
            sorted.sort(
              (a, b) => (a.metrics?.complexity || 0) - (b.metrics?.complexity || 0)
            );
            break;

          case 'coverage-asc':
            sorted.sort((a, b) => a.coverage - b.coverage);
            break;

          case 'coverage-desc':
            sorted.sort((a, b) => b.coverage - a.coverage);
            break;

          case 'filename':
            sorted.sort((a, b) => a.file.localeCompare(b.file));
            break;
        }

        return sorted;
      }

      // Apply all filters and re-render table
      function applyFilters() {
        if (!allGapsData || allGapsData.length === 0) return;

        // Get filter values
        const searchTerm = document.getElementById('searchBox').value.toLowerCase().trim();
        const priorityFilter = document.getElementById('priorityFilter').value;
        const moduleFilter = document.getElementById('moduleFilter').value;
        const sortControl = document.getElementById('sortControl').value;

        // Filter gaps
        let filteredGaps = allGapsData.filter((gap) => {
          // Search filter
          if (searchTerm && !gap.file.toLowerCase().includes(searchTerm)) {
            return false;
          }

          // Priority filter
          if (priorityFilter !== 'ALL' && gap.priority !== priorityFilter) {
            return false;
          }

          // Module filter
          if (moduleFilter !== 'ALL') {
            const gapModule = gap.file.split('/')[0];
            if (gapModule !== moduleFilter) {
              return false;
            }
          }

          return true;
        });

        // Sort gaps
        filteredGaps = sortGaps(filteredGaps, sortControl);

        // Update counts
        document.getElementById('filteredCount').textContent = filteredGaps.length;
        document.getElementById('totalCount').textContent = allGapsData.length;

        // Show/hide clear button
        const hasActiveFilters =
          searchTerm || priorityFilter !== 'ALL' || moduleFilter !== 'ALL' || sortControl !== 'priority';
        document.getElementById('clearFiltersBtn').style.display = hasActiveFilters
          ? 'block'
          : 'none';

        // Update filter status message
        const filterStatus = document.getElementById('filterStatus');
        if (filteredGaps.length === 0 && allGapsData.length > 0) {
          filterStatus.textContent = '(No matches found)';
          filterStatus.className = 'text-red-400 ml-2';
        } else if (filteredGaps.length < allGapsData.length) {
          filterStatus.textContent = '(Filtered)';
          filterStatus.className = 'text-yellow-400 ml-2';
        } else {
          filterStatus.textContent = '';
        }

        // Render filtered gaps
        renderFilteredGaps(filteredGaps);
      }

      // Render filtered gaps to table
      function renderFilteredGaps(gaps) {
        const tbody = document.getElementById('gapsTableBody');

        if (gaps.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="text-center py-8 text-gray-400">
                <div class="text-xl mb-2">üîç</div>
                <div>No gaps match your filters</div>
                <div class="text-sm mt-2">Try adjusting your search or filters</div>
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = gaps
          .map((gap) => {
            const priorityEmoji =
              gap.priority === 'HIGH' ? 'üî¥' : gap.priority === 'MEDIUM' ? 'üü°' : 'üü¢';
            const coverageColor = getCoverageColor(gap.coverage).text;

            const uncoveredLines =
              gap.metrics?.uncoveredLines ||
              (gap.lines ? gap.lines.total - gap.lines.covered : '-');
            const complexity = gap.metrics?.complexity || '-';
            const impact = gap.metrics?.impact || '-';

            return `
              <tr class="border-b border-gray-700 hover:bg-gray-700 transition-colors">
                <td class="py-3 px-4 text-center text-xl">${priorityEmoji}</td>
                <td class="py-3 px-4 font-mono text-xs" title="${gap.fullPath || gap.file}">
                  <div class="max-w-xs truncate">${gap.file}</div>
                  ${gap.reason ? `<div class="text-gray-500 text-xs mt-1">${gap.reason}</div>` : ''}
                </td>
                <td class="py-3 px-4 text-center">
                  <div class="${coverageColor} font-bold">${gap.coverage}%</div>
                  ${gap.details ? `<div class="text-xs text-gray-500 mt-1">B: ${gap.details.branches}% F: ${gap.details.functions}%</div>` : ''}
                </td>
                <td class="py-3 px-4 text-center text-red-400 font-semibold">${uncoveredLines}</td>
                <td class="py-3 px-4 text-center text-yellow-400">${complexity}</td>
                <td class="py-3 px-4 text-center">
                  <span class="px-2 py-1 rounded text-xs ${
                    impact > 200 ? 'bg-red-600' : impact > 100 ? 'bg-yellow-600' : 'bg-blue-600'
                  }">${impact}</span>
                </td>
                <td class="py-3 px-4 text-center">
                  <button onclick="analyzeFile('${gap.fullPath || gap.file}')"
                    class="text-blue-400 hover:text-blue-300 text-xs px-2 py-1 rounded hover:bg-blue-900/30">
                    üéØ Analyze
                  </button>
                </td>
              </tr>
            `;
          })
          .join('');
      }

      // Clear all filters and reset to defaults
      function clearAllFilters() {
        document.getElementById('searchBox').value = '';
        document.getElementById('priorityFilter').value = 'ALL';
        document.getElementById('moduleFilter').value = 'ALL';
        document.getElementById('sortControl').value = 'priority';
        applyFilters();
      }

      // Initialize filter system with data
      function initializeFilters(data) {
        allGapsData = data.gaps || [];
        currentDashboardData = data;

        // Populate module filter
        populateModuleFilter(allGapsData);

        // Set initial counts
        document.getElementById('filteredCount').textContent = allGapsData.length;
        document.getElementById('totalCount').textContent = allGapsData.length;

        // Apply initial filters (shows all by default)
        applyFilters();
      }

      // Load and render dashboard
      async function loadDashboard() {
        try {
          // Try to load data.json, handling both local file and served scenarios
          let dashboardData;
          try {
            const response = await fetch('data.json');
            if (!response.ok) throw new Error('Failed to fetch');
            dashboardData = await response.json();
          } catch (fetchError) {
            // If fetch fails (CORS or file not found), show a helpful message
            console.warn('Could not load data.json:', fetchError);
            document.getElementById('lastUpdate').textContent =
              'No data - Run: npm run test:coverage';

            // Show the hint about serving
            const hint = document.getElementById('viewHint');
            if (hint) hint.style.display = 'block';

            // Show helpful message in the gaps section
            const gapsTableBody = document.getElementById('gapsTableBody');
            if (gapsTableBody) {
              gapsTableBody.innerHTML = `
                <tr>
                  <td colspan="5" class="py-8 text-center">
                    <div class="text-yellow-400 text-lg mb-4">‚ö†Ô∏è No coverage data found</div>
                    <div class="text-gray-400 mb-4">
                      <strong>To view this dashboard properly:</strong><br><br>
                      <strong>Option 1 - Generate data first:</strong><br>
                      <code class="bg-gray-700 px-3 py-1 rounded mt-2 inline-block">
                        cd apps/frontend && npm run test:coverage
                      </code><br><br>
                      <strong>Option 2 - Serve the dashboard (if data exists):</strong><br>
                      <code class="bg-gray-700 px-3 py-1 rounded mt-2 inline-block">
                        cd apps/frontend && npx serve coverage-dashboard
                      </code><br>
                      <span class="text-sm text-gray-500 mt-2 inline-block">
                        Then open the URL shown (usually http://localhost:3000)
                      </span>
                    </div>
                    <div class="text-sm text-gray-500">
                      Note: Opening index.html directly may have CORS restrictions.
                    </div>
                  </td>
                </tr>
              `;
            }
            return;
          }

          // Update last update time
          document.getElementById('lastUpdate').textContent = new Date(
            dashboardData.generated
          ).toLocaleString();

          // Update quick stats
          const current = dashboardData.current;
          document.getElementById('totalTests').textContent = current.tests.total || '-';
          document.getElementById('passingTests').textContent = current.tests.passing || '-';
          document.getElementById('testFiles').textContent = current.tests.files || '-';
          document.getElementById('testDuration').textContent = current.tests.duration || '-';

          // Create gauges
          const coverage = current.coverage;

          charts.statementsGauge = createGauge(
            'statementsGauge',
            coverage.statements,
            getCoverageColor(coverage.statements).bg
          );
          document.getElementById('statementsText').textContent =
            `${coverage.statements.toFixed(1)}%`;
          const stmtDelta = dashboardData.delta?.statements;
          document.getElementById('statementsDelta').textContent = stmtDelta?.text || 'No change';
          if (stmtDelta?.color) {
            document.getElementById('statementsDelta').className =
              `text-sm text-${stmtDelta.color}-400`;
          }

          charts.branchesGauge = createGauge(
            'branchesGauge',
            coverage.branches,
            getCoverageColor(coverage.branches).bg
          );
          document.getElementById('branchesText').textContent = `${coverage.branches.toFixed(1)}%`;
          const branchDelta = dashboardData.delta?.branches;
          document.getElementById('branchesDelta').textContent = branchDelta?.text || 'No change';
          if (branchDelta?.color) {
            document.getElementById('branchesDelta').className =
              `text-sm text-${branchDelta.color}-400`;
          }

          charts.functionsGauge = createGauge(
            'functionsGauge',
            coverage.functions,
            getCoverageColor(coverage.functions).bg
          );
          document.getElementById('functionsText').textContent =
            `${coverage.functions.toFixed(1)}%`;
          const funcDelta = dashboardData.delta?.functions;
          document.getElementById('functionsDelta').textContent = funcDelta?.text || 'No change';
          if (funcDelta?.color) {
            document.getElementById('functionsDelta').className =
              `text-sm text-${funcDelta.color}-400`;
          }

          charts.linesGauge = createGauge(
            'linesGauge',
            coverage.lines,
            getCoverageColor(coverage.lines).bg
          );
          document.getElementById('linesText').textContent = `${coverage.lines.toFixed(1)}%`;
          const linesDelta = dashboardData.delta?.lines;
          document.getElementById('linesDelta').textContent = linesDelta?.text || 'No change';
          if (linesDelta?.color) {
            document.getElementById('linesDelta').className =
              `text-sm text-${linesDelta.color}-400`;
          }

          // Create charts
          if (dashboardData.trends && dashboardData.trends.length > 0) {
            createTrendChart(dashboardData);
          }

          if (dashboardData.modules && dashboardData.modules.length > 0) {
            createModuleChart(dashboardData);
          }

          // Initialize filter system and populate gaps table
          initializeFilters(dashboardData);

          // Populate new sections
          if (dashboardData.insights && dashboardData.insights.length > 0) {
            populateInsights(dashboardData.insights);
          }

          if (dashboardData.summary) {
            populateSummary(dashboardData.summary, dashboardData.metadata);
          }

          if (dashboardData.recommendations && dashboardData.recommendations.length > 0) {
            populateRecommendations(dashboardData.recommendations);
          }

          if (dashboardData.topFiles) {
            populateTopFiles(dashboardData.topFiles);
          }
        } catch (error) {
          console.error('Error loading dashboard:', error);
          document.getElementById('lastUpdate').textContent = 'Error loading data';
        }
      }

      // Populate insights section
      function populateInsights(insights) {
        const section = document.getElementById('insightsSection');
        const container = document.getElementById('insightsContainer');

        if (!insights || insights.length === 0) return;

        section.style.display = 'block';

        const typeIcons = {
          error: 'üî¥',
          warning: 'üü°',
          success: 'üü¢',
          info: 'üîµ',
        };

        const typeColors = {
          error: 'border-red-500 bg-red-900/20',
          warning: 'border-yellow-500 bg-yellow-900/20',
          success: 'border-green-500 bg-green-900/20',
          info: 'border-blue-500 bg-blue-900/20',
        };

        container.innerHTML = insights
          .slice(0, 6)
          .map(
            (insight) => `
          <div class="bg-gray-800 p-4 rounded-lg border-l-4 ${typeColors[insight.type] || typeColors.info}">
            <div class="flex items-start">
              <span class="text-2xl mr-3">${typeIcons[insight.type] || 'üí°'}</span>
              <div class="flex-1">
                <div class="font-semibold text-gray-200 mb-1">${insight.category.toUpperCase()}</div>
                <div class="text-sm text-gray-400">${insight.message}</div>
              </div>
            </div>
          </div>
        `
          )
          .join('');
      }

      // Populate summary section
      function populateSummary(summary, metadata) {
        const section = document.getElementById('summarySection');
        section.style.display = 'block';

        document.getElementById('totalFilesCount').textContent = summary.totalFiles || '-';
        document.getElementById('healthyFilesCount').textContent = summary.healthyFiles || '-';
        document.getElementById('criticalFilesCount').textContent = summary.criticalFiles || '-';
        document.getElementById('avgComplexity').textContent = summary.avgComplexity || '-';

        if (metadata && metadata.velocity) {
          const velocitySection = document.getElementById('velocitySection');
          velocitySection.style.display = 'grid';

          document.getElementById('testsPerDay').textContent =
            metadata.velocity.testsPerDay !== 'NaN' ? metadata.velocity.testsPerDay : '0.0';
          document.getElementById('coverageGain').textContent =
            metadata.velocity.avgCoverageGain + '%';
          document.getElementById('totalRuns').textContent = metadata.totalRuns || '-';
        }
      }

      // Populate recommendations section
      function populateRecommendations(recommendations) {
        const section = document.getElementById('recommendationsSection');
        const container = document.getElementById('recommendationsContainer');

        if (!recommendations || recommendations.length === 0) return;

        section.style.display = 'block';

        const priorityColors = {
          HIGH: 'border-red-500 bg-red-900/10',
          MEDIUM: 'border-yellow-500 bg-yellow-900/10',
          LOW: 'border-blue-500 bg-blue-900/10',
        };

        container.innerHTML = recommendations
          .slice(0, 5)
          .map(
            (rec) => `
          <div class="bg-gray-800 p-6 rounded-lg border-l-4 ${priorityColors[rec.priority] || priorityColors.MEDIUM}">
            <div class="flex items-start justify-between mb-3">
              <div class="font-mono text-sm text-gray-300">${rec.file}</div>
              <span class="px-2 py-1 rounded text-xs font-bold ${
                rec.priority === 'HIGH'
                  ? 'bg-red-600'
                  : rec.priority === 'MEDIUM'
                    ? 'bg-yellow-600'
                    : 'bg-blue-600'
              }">${rec.priority}</span>
            </div>
            <div class="text-gray-400 text-sm mb-3">${rec.reason}</div>
            <div class="space-y-1">
              ${rec.actions
                .map(
                  (action) => `
                <div class="flex items-start text-sm text-gray-300">
                  <span class="mr-2">‚Ä¢</span>
                  <span>${action}</span>
                </div>
              `
                )
                .join('')}
            </div>
          </div>
        `
          )
          .join('');
      }

      // Populate top files section
      function populateTopFiles(topFiles) {
        const section = document.getElementById('topFilesSection');
        section.style.display = 'block';

        // Best coverage
        if (topFiles.bestCoverage && topFiles.bestCoverage.length > 0) {
          const bestList = document.getElementById('bestCoverageList');
          bestList.innerHTML = topFiles.bestCoverage
            .slice(0, 5)
            .map(
              (file) => `
            <div class="flex justify-between items-center p-2 bg-gray-700/50 rounded">
              <span class="text-sm font-mono text-gray-300 truncate flex-1" title="${file.path}">
                ${file.path.split('/').slice(-2).join('/')}
              </span>
              <span class="ml-2 px-2 py-1 rounded text-xs font-bold bg-green-600">
                ${file.coverage}%
              </span>
            </div>
          `
            )
            .join('');
        }

        // Most complex
        if (topFiles.mostComplex && topFiles.mostComplex.length > 0) {
          const complexList = document.getElementById('mostComplexList');
          complexList.innerHTML = topFiles.mostComplex
            .slice(0, 5)
            .map(
              (file) => `
            <div class="p-2 bg-gray-700/50 rounded">
              <div class="flex justify-between items-center mb-1">
                <span class="text-sm font-mono text-gray-300 truncate flex-1" title="${file.path}">
                  ${file.path.split('/').slice(-2).join('/')}
                </span>
                <span class="ml-2 text-xs text-gray-400">${file.coverage}%</span>
              </div>
              <div class="text-xs text-gray-500">
                Complexity: ${file.complexity} | ${file.branches} branches | ${file.functions} functions
              </div>
            </div>
          `
            )
            .join('');
        }
      }

      // Quick action functions
      function refreshDashboard() {
        location.reload();
      }

      function runCoverage() {
        const instructions =
          `üß™ Run Coverage Tests\n\n` +
          `Terminal Command:\n` +
          `  cd apps/frontend\n` +
          `  npm run test:coverage\n\n` +
          `What this does:\n` +
          `  ‚úÖ Runs all Vitest tests\n` +
          `  ‚úÖ Generates coverage report\n` +
          `  ‚úÖ Updates this dashboard automatically\n` +
          `  ‚úÖ Creates trends data\n\n` +
          `Then refresh this page to see updated data!`;

        alert(instructions);

        // Copy command to clipboard if possible
        if (navigator.clipboard) {
          navigator.clipboard.writeText('cd apps/frontend && npm run test:coverage');
        }
      }

      function runTests() {
        const instructions =
          `üß™ Run Tests Only (no coverage)\n\n` +
          `Terminal Command:\n` +
          `  cd apps/frontend\n` +
          `  npm run test\n\n` +
          `For watch mode:\n` +
          `  npm run test:watch\n\n` +
          `For UI mode:\n` +
          `  npm run test:ui`;

        alert(instructions);

        if (navigator.clipboard) {
          navigator.clipboard.writeText('cd apps/frontend && npm run test');
        }
      }

      function getSuggestions() {
        const gaps = dashboardData?.gaps || [];
        const highPriority = gaps.filter((g) => g.priority === 'HIGH').length;
        const mediumPriority = gaps.filter((g) => g.priority === 'MEDIUM').length;

        const suggestions =
          `üìù Test Coverage Suggestions\n\n` +
          `Current Gaps:\n` +
          `  üî¥ ${highPriority} HIGH priority files (<20% coverage)\n` +
          `  üü° ${mediumPriority} MEDIUM priority files (20-40% coverage)\n\n` +
          `Strategy:\n` +
          `  1. Start with HIGH priority files\n` +
          `  2. Focus on untested critical paths\n` +
          `  3. Check "Coverage Gaps" table below\n` +
          `  4. Review detailed report: coverage/index.html\n\n` +
          `  5. Aim for 80%+ on critical modules\n\n` +
          `Tip: Click "üéØ Analyze" on any file in the gaps table for details!`;

        alert(suggestions);
      }

      function exportReport() {
        if (confirm('Export dashboard as PDF?\n\nThis will open the print dialog.')) {
          window.print();
        }
      }

      function analyzeFile(file) {
        const analysis =
          `üìä Analyze Coverage: ${file}\n\n` +
          `Steps:\n` +
          `  1. Open: apps/frontend/coverage/index.html\n` +
          `  2. Search for the filename (Ctrl+F)\n` +
          `  3. Look for highlighted lines:\n` +
          `     üî¥ Red = Uncovered code\n` +
          `     üü¢ Green = Covered code\n\n` +
          `  4. Create tests for uncovered:\n` +
          `     - Functions with 0% coverage\n` +
          `     - Branches not tested\n` +
          `     - Edge cases\n\n` +
          `Tip: Start with functions that have the most impact!`;

        alert(analysis);

        // Try to open the coverage report
        const coveragePath = '../coverage/index.html';
        const a = document.createElement('a');
        a.href = coveragePath;
        a.target = '_blank';
        a.click();
      }

      // Load dashboard on page load
      window.addEventListener('load', loadDashboard);

      // Auto-refresh every 30 seconds (optional)
      // setInterval(loadDashboard, 30000);
    </script>
  </body>
</html>
