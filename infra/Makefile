SHELL := pwsh.exe
.SHELLFLAGS := -NoProfile -Command

# Project directories (relative to infra/)
BACKEND_DIR := ../apps/backend
FRONTEND_DIR := ../apps/frontend
ROOT_DIR := ..

.PHONY: help setup install dev test lint format clean docker-build docker-run

help: ## ğŸ¯ Show available commands for Lokifi full-stack
	@Write-Host ""
	@Write-Host "ğŸš€ Lokifi Full-Stack Development Commands" -ForegroundColor Cyan
	@Write-Host "=========================================" -ForegroundColor Cyan
	@Write-Host ""
	@Write-Host "ğŸ”¥ Quick Start:" -ForegroundColor Green
	@Write-Host "  make start         - Setup and start both backend & frontend" -ForegroundColor Yellow
	@Write-Host "  make dev           - Start development servers" -ForegroundColor Yellow
	@Write-Host "  make test          - Run all tests" -ForegroundColor Yellow
	@Write-Host ""
	@Write-Host "ğŸ› ï¸ Development:" -ForegroundColor Green
	@Write-Host "  make be            - Backend only (FastAPI)" -ForegroundColor Yellow
	@Write-Host "  make fe            - Frontend only (Next.js)" -ForegroundColor Yellow
	@Write-Host "  make api           - Alias for backend" -ForegroundColor Yellow
	@Write-Host "  make web           - Alias for frontend" -ForegroundColor Yellow
	@Write-Host ""
	@Write-Host "ğŸ“¦ Setup & Install:" -ForegroundColor Green
	@Write-Host "  make setup         - Setup both environments" -ForegroundColor Yellow
	@Write-Host "  make install       - Install/update dependencies" -ForegroundColor Yellow
	@Write-Host ""
	@Write-Host "ğŸ§ª Testing:" -ForegroundColor Green
	@Write-Host "  make test-be       - Backend tests only" -ForegroundColor Yellow
	@Write-Host "  make test-fe       - Frontend tests only" -ForegroundColor Yellow
	@Write-Host "  make test-e2e      - End-to-end tests" -ForegroundColor Yellow
	@Write-Host ""
	@Write-Host "ğŸ”§ Code Quality:" -ForegroundColor Green
	@Write-Host "  make lint          - Lint both projects" -ForegroundColor Yellow
	@Write-Host "  make format        - Format both projects" -ForegroundColor Yellow
	@Write-Host "  make check         - Run all quality checks" -ForegroundColor Yellow
	@Write-Host ""
	@Write-Host "ğŸ³ Docker:" -ForegroundColor Green
	@Write-Host "  make docker        - Build and run full stack" -ForegroundColor Yellow
	@Write-Host "  make docker-prod   - Production deployment" -ForegroundColor Yellow
	@Write-Host ""
	@Write-Host "ğŸ§¹ Maintenance:" -ForegroundColor Green
	@Write-Host "  make clean         - Clean all cache files" -ForegroundColor Yellow
	@Write-Host "  make reset         - Reset environments" -ForegroundColor Yellow
	@Write-Host ""
	@Write-Host "â„¹ï¸ Information:" -ForegroundColor Green
	@Write-Host "  make status        - Check system health" -ForegroundColor Yellow
	@Write-Host "  make logs          - Show recent logs" -ForegroundColor Yellow
	@Write-Host ""

# === QUICK START ===
start: setup dev ## ğŸš€ Quick start: setup everything and start development
	@Write-Host "ğŸ‰ Lokifi full-stack started successfully!" -ForegroundColor Green

dev: ## ğŸ”¥ Start both backend and frontend development servers
	@Write-Host "ğŸ”¥ Starting Lokifi development environment..." -ForegroundColor Cyan
	@Write-Host ""
	@Write-Host "âš ï¸ Note: Start servers in separate terminals:" -ForegroundColor Yellow
	@Write-Host "  Terminal 1: cd apps/backend && make dev" -ForegroundColor White
	@Write-Host "  Terminal 2: cd apps/frontend && npm run dev" -ForegroundColor White
	@Write-Host ""
	@Write-Host "Or use VS Code tasks:" -ForegroundColor Yellow
	@Write-Host "  Press Ctrl+Shift+P â†’ 'Tasks: Run Task' â†’ 'ğŸš€ Start All Servers'" -ForegroundColor White
	@Write-Host ""
	@Write-Host "ğŸŒ Frontend: http://localhost:3000" -ForegroundColor Blue
	@Write-Host "ğŸ”§ Backend:  http://localhost:8000" -ForegroundColor Blue
	@Write-Host "ğŸ“– API Docs: http://localhost:8000/docs" -ForegroundColor Blue
	@Write-Host ""

# === INDIVIDUAL SERVICES ===
be: ## ğŸ”§ Start backend only (FastAPI)
	@Write-Host "ğŸ”§ Starting backend development server..." -ForegroundColor Cyan
	@Set-Location $(BACKEND_DIR); make dev

fe: ## ğŸŒ Start frontend only (Next.js)
	@Write-Host "ğŸŒ Starting frontend development server..." -ForegroundColor Cyan
	@Set-Location $(FRONTEND_DIR); npm run dev

api: be ## ğŸ”§ Alias for backend

web: fe ## ğŸŒ Alias for frontend

# === SETUP ===
setup: setup-backend setup-frontend ## ğŸ“¦ Setup both backend and frontend environments
	@Write-Host "âœ… Full-stack environment setup complete!" -ForegroundColor Green

setup-backend: ## ğŸ“¦ Setup backend Python environment
	@Write-Host "ğŸ“¦ Setting up backend environment..." -ForegroundColor Cyan
	@Set-Location $(BACKEND_DIR); make setup

setup-frontend: ## ğŸ“¦ Setup frontend Node.js environment
	@Write-Host "ğŸ“¦ Setting up frontend environment..." -ForegroundColor Cyan
	@if (-not (Test-Path "$(FRONTEND_DIR)/node_modules")) { Set-Location $(FRONTEND_DIR); npm install } else { Write-Host "âœ… Frontend already setup" -ForegroundColor Green }

install: install-backend install-frontend ## ğŸ“¦ Install/update all dependencies

install-backend: ## ğŸ“¦ Install/update backend dependencies
	@Write-Host "ğŸ“¦ Installing backend dependencies..." -ForegroundColor Cyan
	@Set-Location $(BACKEND_DIR); make install

install-frontend: ## ğŸ“¦ Install/update frontend dependencies
	@Write-Host "ğŸ“¦ Installing frontend dependencies..." -ForegroundColor Cyan
	@Set-Location $(FRONTEND_DIR); npm install

# === TESTING ===
test: test-backend test-frontend ## ğŸ§ª Run all tests
	@Write-Host "âœ… All tests completed!" -ForegroundColor Green

test-be: test-backend ## ğŸ§ª Run backend tests only

test-backend: ## ğŸ§ª Run backend tests
	@Write-Host "ğŸ§ª Running backend tests..." -ForegroundColor Cyan
	@Set-Location $(BACKEND_DIR); make test

test-fe: test-frontend ## ğŸ§ª Run frontend tests only

test-frontend: ## ğŸ§ª Run frontend tests
	@Write-Host "ğŸ§ª Running frontend tests..." -ForegroundColor Cyan
	@Set-Location $(FRONTEND_DIR); npm test

test-e2e: ## ğŸ­ Run end-to-end tests
	@Write-Host "ğŸ­ Running end-to-end tests..." -ForegroundColor Cyan
	@Set-Location $(FRONTEND_DIR); npm run test:e2e

test-all: test test-e2e ## ğŸ¯ Run comprehensive test suite

# === CODE QUALITY ===
lint: lint-backend lint-frontend ## ğŸ” Lint both projects
	@Write-Host "âœ… All linting passed!" -ForegroundColor Green

lint-backend: ## ğŸ” Lint backend code
	@Write-Host "ğŸ” Linting backend..." -ForegroundColor Cyan
	@Set-Location $(BACKEND_DIR); make lint

lint-frontend: ## ğŸ” Lint frontend code
	@Write-Host "ğŸ” Linting frontend..." -ForegroundColor Cyan
	@Set-Location $(FRONTEND_DIR); npm run lint

format: format-backend format-frontend ## ğŸ¨ Format both projects
	@Write-Host "âœ… All code formatted!" -ForegroundColor Green

format-backend: ## ğŸ¨ Format backend code
	@Write-Host "ğŸ¨ Formatting backend..." -ForegroundColor Cyan
	@Set-Location $(BACKEND_DIR); make format

format-frontend: ## ğŸ¨ Format frontend code
	@Write-Host "ğŸ¨ Formatting frontend..." -ForegroundColor Cyan
	@Set-Location $(FRONTEND_DIR); npm run format -ErrorAction SilentlyContinue

check: lint test ## âœ… Run all quality checks

# === DATABASE ===
db-init: ## ğŸ—„ï¸ Initialize database
	@Write-Host "ğŸ—„ï¸ Initializing database..." -ForegroundColor Cyan
	@Set-Location $(BACKEND_DIR); make db-init

db-reset: ## ğŸ—‘ï¸ Reset database
	@Write-Host "ğŸ—‘ï¸ Resetting database..." -ForegroundColor Red
	@Set-Location $(BACKEND_DIR); make db-reset

# === DOCKER ===
docker: docker-build docker-run ## ğŸ³ Build and run full stack with Docker

docker-build: ## ğŸ³ Build Docker images
	@Write-Host "ğŸ³ Building Docker images..." -ForegroundColor Cyan
	@Set-Location $(BACKEND_DIR); make docker-build
	@Set-Location $(FRONTEND_DIR); docker build -t lokifi-frontend .

docker-run: ## ğŸ³ Run Docker containers
	@Write-Host "ğŸ³ Running Docker containers..." -ForegroundColor Cyan
	@docker-compose up --build

docker-prod: ## ğŸ­ Production Docker deployment
	@Write-Host "ğŸ­ Starting production deployment..." -ForegroundColor Cyan
	@docker-compose -f docker-compose.prod.yml up --build

docker-dev: ## ğŸ³ Development Docker environment
	@Write-Host "ğŸ³ Starting development containers..." -ForegroundColor Cyan
	@docker-compose up --build

# === MONITORING ===
monitor: ## ğŸ“Š Start monitoring services
	@Write-Host "ğŸ“Š Starting monitoring..." -ForegroundColor Cyan
	@Set-Location $(BACKEND_DIR); make monitor

redis: ## ğŸ”´ Start Redis server
	@Write-Host "ğŸ”´ Starting Redis..." -ForegroundColor Cyan
	@Set-Location $(BACKEND_DIR); make redis

# === MAINTENANCE ===
clean: clean-backend clean-frontend ## ğŸ§¹ Clean all cache files
	@Write-Host "âœ… All cache cleaned!" -ForegroundColor Green

clean-backend: ## ğŸ§¹ Clean backend cache
	@Write-Host "ğŸ§¹ Cleaning backend cache..." -ForegroundColor Cyan
	@Set-Location $(BACKEND_DIR); make clean

clean-frontend: ## ğŸ§¹ Clean frontend cache
	@Write-Host "ğŸ§¹ Cleaning frontend cache..." -ForegroundColor Cyan
	@if (Test-Path "$(FRONTEND_DIR)/.next") { Remove-Item -Recurse -Force "$(FRONTEND_DIR)/.next" }
	@if (Test-Path "$(FRONTEND_DIR)/node_modules/.cache") { Remove-Item -Recurse -Force "$(FRONTEND_DIR)/node_modules/.cache" }
	@if (Test-Path "$(FRONTEND_DIR)/.turbo") { Remove-Item -Recurse -Force "$(FRONTEND_DIR)/.turbo" }
	@Write-Host "âœ… Frontend cache cleaned" -ForegroundColor Green

reset: reset-backend reset-frontend ## ğŸ”„ Reset both environments

reset-backend: ## ğŸ”„ Reset backend environment
	@Write-Host "ğŸ”„ Resetting backend..." -ForegroundColor Cyan
	@Set-Location $(BACKEND_DIR); make reset

reset-frontend: ## ğŸ”„ Reset frontend environment
	@Write-Host "ğŸ”„ Resetting frontend..." -ForegroundColor Cyan
	@if (Test-Path "$(FRONTEND_DIR)/node_modules") { Remove-Item -Recurse -Force "$(FRONTEND_DIR)/node_modules" }
	@if (Test-Path "$(FRONTEND_DIR)/package-lock.json") { Remove-Item -Force "$(FRONTEND_DIR)/package-lock.json" }
	@Set-Location $(FRONTEND_DIR); npm install

# === UTILITIES ===
status: ## ğŸ“Š Check system health
	@Write-Host ""
	@Write-Host "ğŸ“Š Checking system status..." -ForegroundColor Cyan
	@Write-Host ""
	@Write-Host "Backend Health:" -ForegroundColor Yellow
	@try { $$response = Invoke-WebRequest -Uri http://localhost:8000/health -UseBasicParsing -TimeoutSec 2 -ErrorAction Stop; Write-Host "âœ… Backend running" -ForegroundColor Green } catch { Write-Host "âŒ Backend not running" -ForegroundColor Red }
	@Write-Host ""
	@Write-Host "Frontend Status:" -ForegroundColor Yellow
	@try { $$response = Invoke-WebRequest -Uri http://localhost:3000 -UseBasicParsing -TimeoutSec 2 -ErrorAction Stop; Write-Host "âœ… Frontend running" -ForegroundColor Green } catch { Write-Host "âŒ Frontend not running" -ForegroundColor Red }
	@Write-Host ""

logs: ## ğŸ“‹ Show recent logs
	@Write-Host "ğŸ“‹ Recent logs:" -ForegroundColor Cyan
	@Set-Location $(BACKEND_DIR); make logs
	@Write-Host "ğŸ’¡ Frontend logs: Check browser console" -ForegroundColor Yellow

version: ## â„¹ï¸ Show version information
	@Write-Host ""
	@Write-Host "â„¹ï¸ Lokifi Version Information:" -ForegroundColor Cyan
	@Write-Host ""
	@Write-Host "Backend:" -ForegroundColor Yellow
	@Set-Location $(BACKEND_DIR); make version
	@Write-Host ""
	@Write-Host "Frontend:" -ForegroundColor Yellow
	@Write-Host "Node: $$(node --version)" -ForegroundColor White
	@Write-Host "npm:  $$(npm --version)" -ForegroundColor White
	@Write-Host ""

# === PRODUCTION ===
build: build-backend build-frontend ## ğŸ—ï¸ Build production assets
	@Write-Host "âœ… All production builds complete!" -ForegroundColor Green

build-backend: ## ğŸ—ï¸ Build backend for production
	@Write-Host "ğŸ—ï¸ Building backend..." -ForegroundColor Cyan
	@Set-Location $(BACKEND_DIR); make prod-build

build-frontend: ## ğŸ—ï¸ Build frontend for production
	@Write-Host "ğŸ—ï¸ Building frontend..." -ForegroundColor Cyan
	@Set-Location $(FRONTEND_DIR); npm run build

deploy: build ## ğŸš€ Deploy to production
	@Write-Host "ğŸš€ Deploying to production..." -ForegroundColor Cyan
	@Write-Host "âš ï¸ Run deployment scripts here" -ForegroundColor Yellow

# === SHORTCUTS ===
s: dev ## âš¡ Super short alias for dev

t: test ## âš¡ Quick test alias

l: lint ## âš¡ Quick lint alias

f: format ## âš¡ Quick format alias

c: clean ## âš¡ Quick clean alias
