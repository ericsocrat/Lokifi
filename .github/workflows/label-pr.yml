name: 🏷️ Auto-Label PRs

# Automatic PR labeling workflow
# Purpose: Auto-label PRs based on changed files for smart workflow execution
# Runs on: PR open, synchronize (new commits)
# Strategy: Uses labeler.yml config for file-based rules

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

# Cancel in-progress runs for same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  label:
    name: 🏷️ Label Pull Request
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🏷️ Apply labels
        uses: actions/labeler@v6
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: true

      - name: 📝 Comment on first-time PR
        if: github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);

            if (labels.length > 0) {
              const comment = `👋 Thanks for your contribution!

              🏷️ **Auto-applied labels**: ${labels.map(l => \`\`${l}\`\`).join(', ')}

              These labels help determine which CI/CD workflows will run:
              - \`frontend\`: Triggers frontend-specific tests
              - \`backend\`: Triggers backend-specific tests
              - \`e2e-full\`: Runs full E2E test suite (all browsers)
              - \`visual-regression\`: Runs visual regression tests
              - \`performance\`: Runs performance tests

              Labels are automatically updated when you push new commits.`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: 📊 Generate summary
        run: |
          echo "## 🏷️ PR Labels Applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Labels help optimize CI/CD execution by running only relevant workflows." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**How it works**:" >> $GITHUB_STEP_SUMMARY
          echo "- Labels are auto-applied based on changed files" >> $GITHUB_STEP_SUMMARY
          echo "- Workflows use labels for conditional execution" >> $GITHUB_STEP_SUMMARY
          echo "- Updates automatically when new commits are pushed" >> $GITHUB_STEP_SUMMARY
