SHELL := /bin/bash
PYTHON := python
PIP := pip
VENV := venv
VENV_BIN := $(VENV)/bin
VENV_PYTHON := $(VENV_BIN)/python
VENV_PIP := $(VENV_BIN)/pip

# Windows detection and path adjustments
ifeq ($(OS),Windows_NT)
    VENV_BIN := $(VENV)/Scripts
    VENV_PYTHON := $(VENV_BIN)/python.exe
    VENV_PIP := $(VENV_BIN)/pip.exe
    PYTHONPATH := $(shell pwd)
    export PYTHONPATH
else
    export PYTHONPATH := $(shell pwd)
endif

# Colors for output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
PURPLE := \033[0;35m
CYAN := \033[0;36m
NC := \033[0m # No Color

.PHONY: help setup install dev test lint format type-check clean run docker-build docker-run

help: ## ğŸ¯ Show available commands
	@echo -e "$(CYAN)ğŸš€ Fynix Backend Development Commands$(NC)"
	@echo -e "$(CYAN)=====================================$(NC)"
	@echo ""
	@echo -e "$(GREEN)Quick Start:$(NC)"
	@echo -e "  $(YELLOW)make start$(NC)     - Setup everything and start server"
	@echo -e "  $(YELLOW)make dev$(NC)       - Start development server"
	@echo -e "  $(YELLOW)make test$(NC)      - Run all tests"
	@echo ""
	@echo -e "$(GREEN)Available Commands:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-15s$(NC) %s\n", $$1, $$2}'

# === QUICK COMMANDS ===
start: setup run ## ğŸš€ Quick start: setup + run server
	@echo -e "$(GREEN)âœ… Fynix backend started!$(NC)"

dev: setup ## ğŸ”§ Start development server (short alias for run)
	@echo -e "$(CYAN)ğŸ”¥ Starting development server...$(NC)"
	$(VENV_PYTHON) -m uvicorn app.main:app --reload --host 127.0.0.1 --port 8000

s: dev ## âš¡ Super short alias for dev server

t: test ## âš¡ Quick test alias

l: lint-fix ## âš¡ Quick lint and fix

f: format ## âš¡ Quick format alias

# === SETUP ===
setup: $(VENV_BIN)/activate ## ğŸ”§ Create virtual environment and install dependencies
	@echo -e "$(GREEN)âœ… Environment setup complete$(NC)"

$(VENV_BIN)/activate: requirements.txt
	@echo -e "$(CYAN)ğŸ“¦ Creating virtual environment...$(NC)"
	$(PYTHON) -m venv $(VENV)
	$(VENV_PIP) install --upgrade pip setuptools wheel
	$(VENV_PIP) install -r requirements.txt
	@echo -e "$(GREEN)âœ… Dependencies installed$(NC)"

install: setup ## ğŸ“¦ Install/update dependencies
	$(VENV_PIP) install -r requirements.txt
	@echo -e "$(GREEN)âœ… Dependencies updated$(NC)"

# === SERVER COMMANDS ===
run: setup ## ğŸš€ Start FastAPI development server
	@echo -e "$(CYAN)ğŸš€ Starting Fynix backend server...$(NC)"
	$(VENV_PYTHON) -m uvicorn app.main:app --reload --host 127.0.0.1 --port 8000

run-prod: setup ## ğŸ­ Start production server
	@echo -e "$(CYAN)ğŸ­ Starting production server...$(NC)"
	$(VENV_PYTHON) -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4

run-debug: setup ## ğŸ› Start server with debug logging
	@echo -e "$(CYAN)ğŸ› Starting debug server...$(NC)"
	$(VENV_PYTHON) -m uvicorn app.main:app --reload --host 127.0.0.1 --port 8000 --log-level debug

# === TESTING ===
test: setup ## ğŸ§ª Run all tests
	@echo -e "$(CYAN)ğŸ§ª Running tests...$(NC)"
	$(VENV_PYTHON) -m pytest tests/ -v --tb=short

test-fast: setup ## âš¡ Run tests in parallel (faster)
	@echo -e "$(CYAN)âš¡ Running fast tests...$(NC)"
	$(VENV_PYTHON) -m pytest tests/ -v -n auto

test-cov: setup ## ğŸ“Š Run tests with coverage report
	@echo -e "$(CYAN)ğŸ“Š Running tests with coverage...$(NC)"
	$(VENV_PYTHON) -m pytest tests/ -v --cov=app --cov-report=html --cov-report=term-missing

test-security: setup ## ğŸ”’ Run security tests
	@echo -e "$(CYAN)ğŸ”’ Running security tests...$(NC)"
	$(VENV_PYTHON) test_security_features.py

test-stress: setup ## ğŸ’ª Run stress tests
	@echo -e "$(CYAN)ğŸ’ª Running stress tests...$(NC)"
	$(VENV_PYTHON) stress_test_server.py

test-all: test test-security ## ğŸ¯ Run comprehensive test suite

# === CODE QUALITY ===
lint: setup ## ğŸ” Run linting (ruff)
	@echo -e "$(CYAN)ğŸ” Running linter...$(NC)"
	$(VENV_PYTHON) -m ruff check .

lint-fix: setup ## ğŸ”§ Run linting with auto-fix
	@echo -e "$(CYAN)ğŸ”§ Running linter with auto-fix...$(NC)"
	$(VENV_PYTHON) -m ruff check . --fix

format: setup ## ğŸ¨ Format code with black and ruff
	@echo -e "$(CYAN)ğŸ¨ Formatting code...$(NC)"
	$(VENV_PYTHON) -m black .
	$(VENV_PYTHON) -m ruff check . --fix
	@echo -e "$(GREEN)âœ… Code formatted$(NC)"

type-check: setup ## ğŸ”¬ Run type checking with mypy
	@echo -e "$(CYAN)ğŸ”¬ Running type checker...$(NC)"
	$(VENV_PYTHON) -m mypy app/ --ignore-missing-imports

check: lint type-check test ## âœ… Run all checks (lint, type-check, test)
	@echo -e "$(GREEN)âœ… All checks passed!$(NC)"

# === DATABASE ===
db-init: setup ## ğŸ—„ï¸ Initialize database
	@echo -e "$(CYAN)ğŸ—„ï¸ Initializing database...$(NC)"
	$(VENV_PYTHON) -c "from app.core.database import db_manager; import asyncio; asyncio.run(db_manager.initialize())"

db-migrate: setup ## ğŸ”„ Run database migrations
	@echo -e "$(CYAN)ğŸ”„ Running database migrations...$(NC)"
	$(VENV_PYTHON) -m alembic upgrade head

db-reset: setup ## ğŸ—‘ï¸ Reset database (WARNING: deletes all data)
	@echo -e "$(RED)ğŸ—‘ï¸ Resetting database...$(NC)"
	rm -f fynix.sqlite
	$(MAKE) db-init

# === DOCKER ===
docker-build: ## ğŸ³ Build Docker image
	@echo -e "$(CYAN)ğŸ³ Building Docker image...$(NC)"
	docker build -t fynix-backend -f Dockerfile .

docker-run: ## ğŸ³ Run Docker container
	@echo -e "$(CYAN)ğŸ³ Running Docker container...$(NC)"
	docker run -p 8000:8000 --env-file .env fynix-backend

docker-dev: ## ğŸ³ Run with development compose
	@echo -e "$(CYAN)ğŸ³ Starting development containers...$(NC)"
	docker-compose up --build

docker-prod: ## ğŸ³ Run production containers
	@echo -e "$(CYAN)ğŸ³ Starting production containers...$(NC)"
	docker-compose -f docker-compose.prod.yml up --build

# === MONITORING ===
monitor: ## ğŸ“Š Start monitoring services
	@echo -e "$(CYAN)ğŸ“Š Starting monitoring...$(NC)"
	docker-compose -f docker-compose.monitoring.yml up -d

redis: ## ğŸ”´ Start Redis server
	@echo -e "$(CYAN)ğŸ”´ Starting Redis...$(NC)"
	docker-compose -f docker-compose.redis.yml up -d

# === MAINTENANCE ===
clean: ## ğŸ§¹ Remove cache files and build artifacts
	@echo -e "$(CYAN)ğŸ§¹ Cleaning cache files...$(NC)"
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name ".coverage" -delete 2>/dev/null || true
	find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	@echo -e "$(GREEN)âœ… Cache cleaned$(NC)"

clean-venv: ## ğŸ—‘ï¸ Remove virtual environment
	@echo -e "$(CYAN)ğŸ—‘ï¸ Removing virtual environment...$(NC)"
	rm -rf $(VENV)

reset: clean-venv setup ## ğŸ”„ Reset environment (clean + setup)
	@echo -e "$(GREEN)âœ… Environment reset complete$(NC)"

# === UTILITIES ===
deps-update: ## ğŸ“¦ Update requirements.txt with latest versions
	@echo -e "$(CYAN)ğŸ“¦ Updating dependencies...$(NC)"
	$(VENV_PIP) install --upgrade pip-tools
	$(VENV_PYTHON) -m piptools compile --upgrade requirements.in -o requirements.txt

deps-sync: ## ğŸ”„ Sync dependencies with requirements.txt
	$(VENV_PIP) install pip-tools
	$(VENV_PYTHON) -m piptools sync requirements.txt

shell: setup ## ğŸ Open Python shell with app context
	@echo -e "$(CYAN)ğŸ Opening Python shell...$(NC)"
	$(VENV_PYTHON) -c "from app.main import app; import IPython; IPython.embed()"

version: ## â„¹ï¸ Show versions of key dependencies
	@echo -e "$(CYAN)â„¹ï¸ Version Information:$(NC)"
	@echo -e "Python: $$($(VENV_PYTHON) --version)"
	@echo -e "FastAPI: $$($(VENV_PYTHON) -c 'import fastapi; print(fastapi.__version__)' 2>/dev/null || echo 'Not installed')"
	@echo -e "aiohttp: $$($(VENV_PYTHON) -c 'import aiohttp; print(aiohttp.__version__)' 2>/dev/null || echo 'Not installed')"

logs: ## ğŸ“‹ Show recent logs
	@echo -e "$(CYAN)ğŸ“‹ Recent logs:$(NC)"
	tail -n 50 logs/*.log 2>/dev/null || echo "No logs found"

health: setup ## ğŸ¥ Check system health
	@echo -e "$(CYAN)ğŸ¥ Checking system health...$(NC)"
	$(VENV_PYTHON) -c "
import asyncio
from app.core.database import db_manager
from app.core.advanced_redis_client import advanced_redis_client

async def health_check():
    print('ğŸ” Database:', 'OK' if await db_manager.health_check() else 'FAIL')
    print('ğŸ” Redis:', 'OK' if await advanced_redis_client.health_check() else 'FAIL')

asyncio.run(health_check())
"

# === SHORTCUTS ===
status: health ## ğŸ“Š Alias for health check

# === FULL STACK COMMANDS ===
fullstack-dev: ## ğŸŒ Start both backend and frontend (requires terminal multiplexing)
	@echo -e "$(CYAN)ğŸŒ Starting full stack development...$(NC)"
	@echo -e "$(YELLOW)Note: This requires running frontend separately$(NC)"
	@echo -e "$(YELLOW)Run 'cd ../frontend && npm run dev' in another terminal$(NC)"
	$(MAKE) dev

# Production builds
prod-build: ## ğŸ­ Build production Docker image
	docker build -t fynix-backend:prod -f Dockerfile.prod .

prod-run: ## ğŸ­ Run production container
	docker run -p 8000:8000 --env-file .env fynix-backend:prod